using System;
using System.Collections.Generic;
using static OopTask10.UserUtils;

namespace OopTask10
{
    internal class Program
    {
        static void Main(string[] args)
        {
            War war = new War();
            war.Play();
        }
    }

    public class UserUtils
    {
        public static Random s_random = new Random();

        public static int GenerateRandomNumber(int minimumValue, int maximumValue)
        {
            return s_random.Next(minimumValue, maximumValue);
        }
    }

    public class UserInterface
    {
        public static void ShowPressAnyKeyForContinueMessage()
        {
            Console.WriteLine("\nдля продолжения нажмите любую клавишу...");
            Console.ReadKey();
            Console.Clear();
        }
    }

    public class War
    {
        public List<Soldier> SoldierTypes { get; private set; }

        public void Play()
        {
            const string CommandStartBattle = "1";
            const string CommandExit = "2";

            bool isContinue = true;

            while (isContinue)
            {
                Console.Clear();
                Console.WriteLine($"Вы можете выбрать одну из следующих опций:\n" +
                    $"\nСформировать взводы и начать бой - {CommandStartBattle}" +
                    $"\nВыйти из программы - {CommandExit}\n");
                string userInput = Console.ReadLine();
                Console.Clear();

                switch (userInput)
                {
                    case CommandStartBattle:
                        StartBattle();
                        break;

                    case CommandExit:
                        isContinue = false;
                        break;

                    default:
                        Console.WriteLine("Введена неверная команда");
                        break;
                }

                UserInterface.ShowPressAnyKeyForContinueMessage();
            }

            Console.WriteLine("Вы вышли из программы...");
        }

        private List<Soldier> FormSoldiersList()
        {
            int minimumSoldiersNumber = 5;
            int maximumSoldiersNumber = 8;
            int soldiersNumber = GenerateRandomNumber(minimumSoldiersNumber, maximumSoldiersNumber);
            List<Soldier> platoonSoldiersList = new List<Soldier>(soldiersNumber);
            int soldierTypeIndex;
            Console.WriteLine($"Размер взвода составит: {soldiersNumber}");

            for (int i = 0; i < platoonSoldiersList.Capacity; i++)
            {
                SoldierTypes = new List<Soldier>()
                {
                    new Soldier(1500, 50, 100),
                    new Sniper(1200, 20, 150, 2),
                    new Splasher(800, 40, 70),
                    new MultipleAttacker(1000, 10, 100)
                };
                soldierTypeIndex = GenerateRandomNumber(0, SoldierTypes.Count);
                platoonSoldiersList.Add(SoldierTypes[soldierTypeIndex]);
                Console.WriteLine("Добавлен солдат типа: " + SoldierTypes[soldierTypeIndex].Type);
            }

            UserInterface.ShowPressAnyKeyForContinueMessage();
            return platoonSoldiersList;
        }

        private void StartBattle()
        {
            Platoon firstPlatoon = new Platoon(FormSoldiersList());
            Platoon secondPlatoon = new Platoon(FormSoldiersList());

            while (firstPlatoon.GetSoldiersListCount() > 0 && secondPlatoon.GetSoldiersListCount() > 0)
            {
                Console.WriteLine("Первый взвод атакует второй взвод!\n");
                firstPlatoon.Attack(secondPlatoon);
                UserInterface.ShowPressAnyKeyForContinueMessage();
                
                if (secondPlatoon.GetSoldiersListCount() > 0)
                {
                    Console.WriteLine("Второй взвод атакует первый взвод!\n");
                    secondPlatoon.Attack(firstPlatoon);
                    UserInterface.ShowPressAnyKeyForContinueMessage();
                }
            }

            DeterminateWinnerPlatoon(firstPlatoon, secondPlatoon);
        }

        private void DeterminateWinnerPlatoon(Platoon firstPlatoon, Platoon secondPlatoon)
        {
            if (firstPlatoon.GetSoldiersListCount() == 0 && secondPlatoon.GetSoldiersListCount() > 0)
            {
                Console.WriteLine("Победил второй взвод!");
            }
            else if (firstPlatoon.GetSoldiersListCount() > 0 && secondPlatoon.GetSoldiersListCount() == 0)
            {
                Console.WriteLine("Победил первый взвод!");
            }
            else if (firstPlatoon.GetSoldiersListCount() == 0 && secondPlatoon.GetSoldiersListCount() == 0)
            {
                Console.WriteLine("Ничья!");
            }
        }
    }

    public class Platoon
    {
        private List<Soldier> _soldiersList = new List<Soldier>();

        public Platoon(List<Soldier> soldiersList)
        {
            _soldiersList = soldiersList;
        }

        public int GetSoldiersListCount()
        {
            return _soldiersList.Count;
        }

        public void Attack(Platoon platoon)
        {
            int attackingSoldierNumber = 0;

            if (_soldiersList.Count > 0)
            {
                foreach (Soldier soldier in _soldiersList)
                {
                    if (platoon._soldiersList.Count > 0)
                    {
                        attackingSoldierNumber++;
                        Console.WriteLine($"Атакует солдат под номером {attackingSoldierNumber}\n");
                        soldier.Attack(platoon._soldiersList);
                    }
                    else
                    {
                        Console.WriteLine("Во вражеском взводе не осталось солдат!");
                        break;
                    }
                }
            }
            else
            {
                Console.WriteLine("В этом взводе не осталось солдат!");
            }
        }
    }

    public class Soldier
    {
        public Soldier(int health, int armor, int damage)
        {
            Health = health;
            Armor = armor;
            Damage = damage;
            Type = "обычный солдат";
        }

        public int Health { get; protected set; }
        public int Armor { get; protected set; }
        public int Damage { get; protected set; }
        public string Type {  get; protected set; }

        public virtual void Attack(List<Soldier> soldiers)
        {
            int attackedEnemyIndex = GenerateRandomNumber(0, soldiers.Count);
            int makedDamage = Damage - soldiers[attackedEnemyIndex].Armor;
            MakeDamage(attackedEnemyIndex, soldiers, makedDamage);
        }

        public virtual void TakeDamage(int takedDamage)
        {
            Health -= takedDamage;

            if (Health < 0)
            {
                Health = 0;
            }
        }

        public virtual void MakeDamage(int attackedEnemyIndex, List<Soldier> soldiers, int makedDamage)
        {
            soldiers[attackedEnemyIndex].TakeDamage(makedDamage);
            int attackedEnemyNumber = attackedEnemyIndex + 1;

            if (soldiers[attackedEnemyIndex].Health > 0)
            {
                Console.WriteLine($"{Type} атакует солдата противника под номером {attackedEnemyNumber} типа '{soldiers[attackedEnemyIndex].Type}'" +
                    $"\nи наносит урона: {makedDamage}\n" +
                    $"Оставшееся здоровье атакованного солдата: {soldiers[attackedEnemyIndex].Health}\n");
            }
            else
            {
                soldiers[attackedEnemyIndex].Health = 0;
                Console.WriteLine($"{Type} атакует солдата противника под номером {attackedEnemyNumber} типа '{soldiers[attackedEnemyIndex].Type}'" +
                    $"\nи убивает его!\n");
                Soldier diedSoldier = soldiers[attackedEnemyIndex];
                soldiers.Remove(diedSoldier);
            }
        }
    }

    public class Sniper : Soldier
    {
        public Sniper(int health, int armor, int damage, int damageMultiplier) : base(health, armor, damage*damageMultiplier) 
        {
            Type = "снайпер";
        }
    }

    public class Splasher : Soldier 
    {
        public Splasher(int health, int armor, int damage) : base(health, armor, damage) 
        {
            Type = "сплэшер";
        }
        
        public override void Attack(List <Soldier> soldiers) 
        {
            int attackedEmemiesNumber = 3;
            int attackedEnemyIndex;

            if (attackedEmemiesNumber > soldiers.Count)
            {
                attackedEmemiesNumber = soldiers.Count;
            }

            List<int> attackedEnemiesIndexes = new List<int>(attackedEmemiesNumber);

            for (int i = 0; i < attackedEmemiesNumber; i++)
            {
                attackedEnemyIndex = GenerateRandomNumber(0, soldiers.Count);

                if (attackedEnemiesIndexes.Contains(attackedEnemyIndex) == false)
                {
                    attackedEnemiesIndexes.Add(attackedEnemyIndex);
                    int makedDamage = Damage - soldiers[attackedEnemyIndex].Armor;
                    MakeDamage(attackedEnemyIndex, soldiers, makedDamage);
                }
                else
                {
                    i--;
                }
            }
        }
    }

    public class MultipleAttacker : Soldier
    {
        public MultipleAttacker(int health, int armor, int damage) : base(health, armor, damage) 
        {
            Type = "множественный атакователь";
        }
        
        public override void Attack(List<Soldier> soldiers)
        {
            int attacksNumber = 3;
            int attackedEnemyIndex;

            if (attacksNumber > soldiers.Count)
            {
                attacksNumber = soldiers.Count;
            }

            for (int i = 0; i < attacksNumber; i++)
            {
                attackedEnemyIndex = GenerateRandomNumber(0, soldiers.Count);
                int makedDamage = Damage - soldiers[attackedEnemyIndex].Armor;

                if (soldiers[attackedEnemyIndex].Health > 0)
                {
                    MakeDamage(attackedEnemyIndex, soldiers, makedDamage);
                }
            }
        }
    }
}
